    - name: Create MySQL databases # depends on python-mysqldb (currently installed in various-packages)
      mysql_db: name=kifi_emo collation=utf8_unicode_ci state=present

    - name: Setup users for MySQL databases
      mysql_user: name={{ db.name }} password={{ db.password }} priv={{ db.name }}.*:ALL state=present

# TODO: run drush site-install -y --db-url=mysql://{{ db.user }}:{{ db.password }}@localhost/{{ db.name }} but figure out a way to check whether or not the DB is there first


    - name: Check out Drupal core from version control
      git: repo={{ drupal_git }}drupal.git dest=/srv/sites/{{site_name}}/www version={{ core }}

    - name: Check out Drupal modules from version control
      git: repo={{ drupal_git }}{{ item.name }}.git dest=/srv/sites/{{site_name}}/www/sites/all/modules/{{item.name}} version={{ item.version }}
      with_items: modules
      when: modules is defined

    - name: Check out Drupal themes from version control
      git: repo={{ drupal_git }}{{ item.name }}.git dest=/srv/sites/{{site_name}}/www/sites/all/themes/{{item.name}} version={{ item.version }}
      with_items: themes
      when: themes is defined

    - name: Check out local repositories
      git: repo={{ kifi_git }}{{ item.name }} dest=/srv/sites/{{site_name}}/www/{{item.dest}} version={{ item.version }}
      with_items: kifi_locals 
      when: kifi_locals is defined 
 
    - name: Apache config for site
      template: src=../templates/apache-site-drupal8.j2 dest=/etc/apache2/sites-available/{{site_name}} owner=root group=root mode=0644

    # TODO: consider just moving to ACLs for shared config to get rid of all the permission issues
    - name: Set git to ignore permission changes
      command: /usr/bin/git --git-dir=/srv/sites/{{ site_name }}/www/.git --work-tree=/srv/sites/{{ site_name }}/www config core.filemode false

    - name: Set main directory permissions
      file: path=/srv/sites/{{ site_name }} owner=root group=git mode=0775 state=directory recurse=yes

    - name: Set files directory permissions
      file: path=/srv/sites/{{ site_name }}/www/sites/default/files owner=root group=www-data mode=2775 state=directory

    - name: Set sticky bit for all directories in site and execute for all
      shell: find /srv/sites/{{ site_name }} -type d -exec chmod +x,g+s {} \;


    - name: Enable site in apache config
      file: src=/etc/apache2/sites-available/{{ site_name }} dest=/etc/apache2/sites-enabled/{{ site_name }} owner=root group=root state=link

